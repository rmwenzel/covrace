---
title: "code"
output: html_document
---



```{r}
library(dplyr)

# read in blockgroup demographic and provider data
dem <- read.csv('data/us-dem-counts-jan-2021.csv', header=TRUE, colClasses=c("spatial_id"="character"))

# select columns needed for model
dem <- dem %>% select(spatial_id, BlackNotHispPercent, HispanicPercent, NativePercent, Population, NumProviders)

# note - some blockgroups are missing population data, we're waiting for update
# from Simply Analytics - we drop values for now
dem <- na.omit(dem)

# scale independent variables but not offset
dem <- dem %>% mutate_at(c("BlackNotHispPercent", "HispanicPercent", "NativePercent"), ~(scale(.) %>% as.vector))
```


```{r}
library(sf)
library(sp)

# read in blockgroup geodata
geom.sf <- st_read('data/us-test-sites-nov-2020.shp')
geom.sp <- as(geom.sf, "Spatial")

```



```{r}

library(spdep)
library(CARBayes)

if (file.exists("data/neighbors.rds")) {
neighbors <- readRDS("data/neighbors.rds")
} else {
system.time(neighbors <- poly2nb(geom.sp,
                   queen = TRUE,
                   snap = 0)
            )
saveRDS(neighbors, file="data/neighbors.rds")
}
```


```{r}
if (file.exists("data/neighbors_mat.rds")) {
neighbors_mat <- readRDS("data/neighbors_mat.rds")
} else {
neighbors_mat<- nb2mat_par(neighbors,
                      zero.policy = TRUE,
                      style = "B")
saveRDS(neighbors, file="data/neighbors_mat.rds")
}
```

```

```{r}
ns <- S.CARleroux(formula = NumProviders ~ BlackNotHispPercent + HispanicPercent + NativePercent + offset(log(Population + 1)), data = dem_sc, family = "poisson", burnin = 100000, n.sample = 1100000, thin = 100, W = neighbors_mat, prior.mean.beta = rep(0, times = 4), prior.var.beta = rep(100^2, times = 4), prior.tau2 = c(0.01, 0.01))
```
